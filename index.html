<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stonkz India | Live Multiplayer</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        :root {
            --bg: #0b0e14; --card: #161b22; --primary: #58a6ff;
            --success: #238636; --danger: #da3633; --text: #c9d1d9;
            --border: #30363d; --highlight: #f0883e;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; }
        .container { width: 100%; max-width: 1200px; margin: 0 auto; }
        .hidden { display: none !important; }
        #login-screen, #reg-screen { text-align: center; background: var(--card); padding: 50px; border-radius: 20px; margin-top: 10vh; border: 1px solid var(--border); }
        .header { background: var(--card); padding: 20px; border-radius: 12px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border); }
        .wallet-box { background: #23863622; padding: 10px 20px; border-radius: 8px; border: 1px solid var(--success); color: var(--success); font-weight: bold; }
        .table-wrapper { background: var(--card); border-radius: 12px; border: 1px solid var(--border); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 850px; }
        th { background: #1c2128; padding: 15px; text-align: left; color: #8b949e; font-size: 0.8rem; text-transform: uppercase; }
        td { padding: 15px; border-bottom: 1px solid var(--border); }
        .price-tag { font-family: monospace; font-weight: bold; color: var(--success); font-size: 1.2rem; }
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; }
        .btn-p { background: var(--primary); color: #fff; }
        .btn-s { background: var(--success); color: #fff; }
        .btn-d { background: var(--danger); color: #fff; }
        input { background: #0d1117; border: 1px solid var(--border); color: white; padding: 8px; border-radius: 4px; }
    </style>
</head>
<body>

<div class="container">
    <div id="login-screen">
        <h1>STONKZ ðŸ“ˆ</h1>
        <button class="btn btn-p" onclick="showReg()">Join Player</button>
        <button class="btn btn-s" onclick="authHost()">Join Host</button>
    </div>

    <div id="reg-screen" class="hidden">
        <h2>Enter Name</h2>
        <input type="text" id="pName" placeholder="Your Name"><br><br>
        <button class="btn btn-p" onclick="startPlayer()">Start Game</button>
    </div>

    <div id="game-dashboard" class="hidden">
        <div class="header">
            <div><small>USER:</small> <span id="display-name" style="color:var(--primary); font-weight:bold;"></span></div>
            <div class="wallet-box" id="wallet-ui">Wallet: â‚¹<span id="wallet-val">1500</span></div>
            <button class="btn btn-d" onclick="location.reload()">Exit</button>
        </div>
        <div class="table-wrapper">
            <table>
                <thead><tr><th>Company</th><th>Price</th><th>Market Stock</th><th>Actions</th></tr></thead>
                <tbody id="market-list"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // --- 1. FIREBASE CONFIGURATION ---
    // REPLACE THIS WITH YOUR FIREBASE PROJECT CONFIG
    const firebaseConfig = {
        apiKey: "YOUR_API_KEY",
        authDomain: "YOUR_PROJECT.firebaseapp.com",
        databaseURL: "https://x-plore-25-default-rtdb.firebaseio.com/",
        projectId: "YOUR_PROJECT",
        storageBucket: "YOUR_PROJECT.appspot.com",
        messagingSenderId: "YOUR_ID",
        appId: "YOUR_APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- 2. GAME STATE ---
    let wallet = 1500;
    let myName = "";
    let role = "";
    let myStocks = {}; 

    const stockNames = [
        "Bajaj Finance", "Groww", "Swiggy", "Paytm", "IDFC First Bank", 
        "Tata Motors", "Bank of India", "IRCTC", "Nykaa", "Dabur India", 
        "Oil India", "Mankind Pharma", "ITC", "Yes Bank", "IndiGo"
    ];

    // --- 3. DATABASE INITIALIZATION ---
    // This function sets up the 20rs base price in the cloud
    function initDatabase() {
        stockNames.forEach((name, i) => {
            db.ref('market/' + i).set({
                name: name,
                price: 20, // UPDATED TO 20RS
                available: 50
            });
        });
    }

    // --- 4. NAVIGATION ---
    function showReg() { 
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('reg-screen').classList.remove('hidden');
    }

    function startPlayer() {
        myName = document.getElementById('pName').value;
        if(!myName) return;
        role = "player";
        enterGame();
    }

    function authHost() {
        if(prompt("Password?") === "stockhost2025") {
            myName = "Admin";
            role = "host";
            enterGame();
        }
    }

    function enterGame() {
        document.getElementById('reg-screen').classList.add('hidden');
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('game-dashboard').classList.remove('hidden');
        document.getElementById('display-name').innerText = myName;
        if(role === 'host') document.getElementById('wallet-ui').classList.add('hidden');
        
        // Listen to Database Updates Live
        db.ref('market').on('value', (snapshot) => {
            render(snapshot.val());
        });
    }

    // --- 5. RENDER MARKET ---
    function render(data) {
        const list = document.getElementById('market-list');
        list.innerHTML = "";
        data.forEach((s, i) => {
            const tr = document.createElement('tr');
            let actions = (role === 'player') ? `
                <td>
                    <input type="number" id="qty-${i}" value="1" style="width:40px">
                    <button class="btn btn-s" onclick="trade(${i}, 'buy', ${s.price}, ${s.available})">Buy</button>
                    <button class="btn btn-d" onclick="trade(${i}, 'sell', ${s.price}, ${s.available})">Sell</button>
                    <div style="font-size:0.7rem">Owned: ${myStocks[i] || 0}</div>
                </td>` : `
                <td>
                    <input type="number" id="host-p-${i}" value="${s.price}">
                    <button class="btn btn-p" onclick="hostPrice(${i})">Set</button>
                </td>`;

            tr.innerHTML = `<td>${s.name}</td><td class="price-tag">â‚¹${s.price.toFixed(2)}</td><td>${s.available}</td>${actions}`;
            list.appendChild(tr);
        });
    }

    // --- 6. CORE MULTIPLAYER LOGIC ---
    function trade(id, type, price, available) {
        const qty = parseInt(document.getElementById('qty-'+id).value);
        if(type === 'buy') {
            if(qty > available || (qty*price) > wallet) return alert("Invalid Trade");
            wallet -= (qty * price);
            myStocks[id] = (myStocks[id] || 0) + qty;
            
            // Push update to everyone in the database
            db.ref('market/' + id).update({
                available: available - qty,
                price: price * (1 + (qty * 0.02)) // Price rises for ALL
            });
        } else {
            if(!myStocks[id] || qty > myStocks[id]) return alert("No stock to sell");
            wallet += (qty * price);
            myStocks[id] -= qty;
            
            db.ref('market/' + id).update({
                available: available + qty,
                price: price * (1 - (qty * 0.02)) // Price drops for ALL
            });
        }
        document.getElementById('wallet-val').innerText = wallet.toFixed(2);
    }

    function hostPrice(id) {
        const newP = parseFloat(document.getElementById('host-p-'+id).value);
        db.ref('market/' + id).update({ price: newP });
    }
</script>
</body>
</html>